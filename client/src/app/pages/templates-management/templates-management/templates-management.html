<div class="page">
  <app-nav-bar></app-nav-bar>
  <div class="container">
    <div class="header-section">
      <h1>Manage Templates</h1>
      <button class="primary-button" (click)="createTemplate()">
        <i class="fa-solid fa-plus"></i> Create New Template
      </button>
    </div>

    <!-- Search and Filter -->
    <div class="filter-section">
      <div class="search-box">
        <input type="text" [formControl]="searchControl" placeholder="Search templates..." class="search-input">
        <i class="fas fa-search search-icon"></i>
      </div>
      
      <form [formGroup]="dateSearchForm" class="date-filters">
        <div class="date-range">
          <div class="date-input">
            <label for="startDate">From:</label>
            <input type="date" id="startDate" formControlName="startDate">
          </div>
          <div class="date-input">
            <label for="endDate">To:</label>
            <input type="date" id="endDate" formControlName="endDate">
          </div>
        </div>
      </form>
    </div>

    <!-- Templates List -->
    <div class="templates-section">
      <div class="templates-count">
        <p><i class="fa-solid fa-circle-info"></i> Found {{filteredTemplates.length}} templates</p>
      </div>
      
      @if (isLoading) {
        <div class="loading-spinner">Loading templates...</div>
      } @else if (pagedItems.length === 0) {
        <div class="no-templates">
          <p>No templates found. Create a new template to get started.</p>
        </div>
      } @else {
        <table class="templates-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Date Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (template of pagedItems; track template.id) {
              <tr (click)="viewTemplateDetails(template)" class="clickable-row">
                <td>{{template.name}}</td>
                <td>{{formatDate(template.dateCreated)}}</td>
                <td class="actions-cell">
                  <button class="action-button view-button" (click)="viewTemplateDetails(template); $event.stopPropagation()">
                    <i class="fa-solid fa-eye"></i> View
                  </button>
                  <button class="action-button edit-button" (click)="editTemplate(template.id); $event.stopPropagation()">
                    <i class="fa-solid fa-pen-to-square"></i> Edit
                  </button>
                  <button class="action-button delete-button" (click)="openDeleteConfirmation(template.id, $event)">
                    <i class="fa-solid fa-trash"></i> Delete
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
        
        <!-- Pagination -->
        <div class="pagination-container">
          <app-pagination 
            [totalItems]="filteredTemplates.length"
            [pageSize]="pageSize"
            [currentPage]="currentPage"
            (pageChanged)="onPageChanged($event)">
          </app-pagination>
        </div>
      }
    </div>

    <!-- Success/Error Messages -->
    @if (deleteSuccessMessage) {
      <div class="success-message">
        {{deleteSuccessMessage}}
      </div>
    }
    
    @if (errorMessage) {
      <div class="error-message">
        {{errorMessage}}
      </div>
    }
  </div>

  <!-- Template Details Modal -->
  @if (selectedTemplate) {
    <div class="modal-overlay" (click)="closeDetails()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{selectedTemplate.name}}</h2>
          <button class="close-btn" (click)="closeDetails()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="modal-body">
          <p><strong>Created:</strong> {{formatDate(selectedTemplate.dateCreated)}}</p>
          
          <h3>Diet Schedule</h3>
          <table class="diet-details-table">
            <thead>
              <tr>
                <th>Meal Type</th>
                <th>Monday</th>
                <th>Tuesday</th>
                <th>Wednesday</th>
                <th>Thursday</th>
                <th>Friday</th>
                <th>Saturday</th>
                <th>Sunday</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="meal-type">Breakfast</td>
                @for (day of selectedTemplate.days; track day.id) {
                  <td>
                    @for (meal of day.meals; track meal.id) {
                      @if (meal.mealType === 'Breakfast' || meal.type === 'Breakfast') {
                        {{meal.meal}}
                      }
                    }
                  </td>
                }
              </tr>
              <tr>
                <td class="meal-type">Morning Snack</td>
                @for (day of selectedTemplate.days; track day.id) {
                  <td>
                    @for (meal of day.meals; track meal.id) {
                      @if (meal.mealType === 'Morning Snack' || meal.type === 'Morning Snack') {
                        {{meal.meal}}
                      }
                    }
                  </td>
                }
              </tr>
              <tr>
                <td class="meal-type">Lunch</td>
                @for (day of selectedTemplate.days; track day.id) {
                  <td>
                    @for (meal of day.meals; track meal.id) {
                      @if (meal.mealType === 'Lunch' || meal.type === 'Lunch') {
                        {{meal.meal}}
                      }
                    }
                  </td>
                }
              </tr>
              <tr>
                <td class="meal-type">Afternoon Snack</td>
                @for (day of selectedTemplate.days; track day.id) {
                  <td>
                    @for (meal of day.meals; track meal.id) {
                      @if (meal.mealType === 'Afternoon Snack' || meal.type === 'Afternoon Snack') {
                        {{meal.meal}}
                      }
                    }
                  </td>
                }
              </tr>
              <tr>
                <td class="meal-type">Dinner</td>
                @for (day of selectedTemplate.days; track day.id) {
                  <td>
                    @for (meal of day.meals; track meal.id) {
                      @if (meal.mealType === 'Dinner' || meal.type === 'Dinner') {
                        {{meal.meal}}
                      }
                    }
                  </td>
                }
              </tr>
            </tbody>
          </table>
          
          <!-- Action buttons -->
          <div class="modal-action-buttons">
            <button (click)="editTemplate(selectedTemplate.id)" class="edit-button">
              <i class="fa-solid fa-pen-to-square"></i> Edit
            </button>
            <button (click)="openDeleteConfirmation(selectedTemplate.id)" class="delete-button">
              <i class="fa-solid fa-trash"></i> Delete
            </button>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Delete Confirmation Modal -->
  @if (showDeleteConfirmation) {
    <div class="confirmation-modal">
      <div class="confirmation-content">
        <h3>Confirm Deletion</h3>
        <p>Are you sure you want to delete this template? This action cannot be undone.</p>
        <div class="confirmation-buttons">
          <button (click)="cancelDelete()" class="cancel-button">Cancel</button>
          <button (click)="confirmDelete()" class="confirm-button">Delete</button>
        </div>
      </div>
    </div>
  }
</div>